---
title: Research skills self-efficacy and experimental design aptitude among first-semester
  bioscience graduate students (2017 & 2018 data)
output:
  pdf_document: default
  html_notebook: default
  html_document: default
  word_document: default
---

#Library & Data Import

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook detailing all of the data analysis completed for the paper entitled "Research skills self-efficacy and experimental design aptitude among first-semester bioscience graduate students." 

**Analysis was performed by K. Lachance and this notebook was compiled on February 4, 2019.**

Import libraries and packages required for analysis and visualization and set seed for reproducibility
```{r}
list.of.packages <- c("reshape2", "ggplot2", "gridExtra", "grid", "orddom", "svglite")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(reshape2) # Data structure manipulation
library(ggplot2) # Plotting
library(gridExtra) # Plotting
library(grid) # Plotting
library(orddom) # Statistics
library(svglite) # Plotting

# Make jitter plots and other analyses / visualizations reproducible
set.seed(123)
```

Import data, contained in ExperimentalDesignData.csv file. Each row corresponds to a student (identified with an anonymous code) and each column contains information about that student's response about research skills self-efficacy, experimental design aptitude, experience, and demographic information. In total, 103 students were surveyed (only students that completed all pre- and post-test assessments were included in this study). 
```{r}
data = read.csv(file = "./ExperimentalDesignData.csv", header = TRUE, row.names = 1) # Import data
numStudents = nrow(data) # Calculate number of students in cohort to be analyzed

# Print output
cat(paste("There are ", numStudents, " student responses contained in the following analyses.\n", sep ="")) 
```

***

# Figure 1: Students entering graduate school have heterogeneous backgrounds

Students have worked in a research lab for between < 2 to > 7 years before attending graduate school, with more than one third having less than 3 years of prior research experience.
```{r}
# Make a data frame holding frequency of students' previous research experience
df <- melt(table(data$LabExp))
colnames(df) = c("Years", "Freq")
df$Years = as.character(df$Years)
df$Percent = round((df$Freq / numStudents) * 100, 2)

# Print output
cat(paste(df$Percent[1], "% of students had < 2 years previous experience working in a research laboratory.\n",
          df$Percent[2], "% of students had 2 - 3 years previous experience working in a research laboratory.\n",
          df$Percent[3], "% of students had 3 - 4 years previous experience working in a research laboratory.\n",
          df$Percent[4], "% of students had 4 - 5 years previous experience working in a research laboratory.\n",
          df$Percent[5], "% of students had 5 - 6 years previous experience working in a research laboratory.\n",
          df$Percent[6], "% of students had 6 - 7 years previous experience working in a research laboratory.\n",
          df$Percent[7], "% of students had > 7 years previous experience working in a research laboratory.\n", sep = ""))

# Make pie chart
df$Years <- factor(df$Years, levels = c("7", "6", "5", "4", "3", "2", "1"))
fig1a <- ggplot(df, aes(x="", y=Percent, fill=Years))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values=c("#333333", "#4C4C4C", "#666666", "#808080", "#999999", "#B2B2B2", "#CCCCCC")) + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

plot(fig1a)
ggsave(fig1a, file="Fig1A.svg", width = 2, height = 2)



# FIG 4
#df1 <- data.frame(Cat = c("CC", "Lab", "Sem", "Mentor", "Discussing", "Present", "Write", "Read"), Freq = c(9, 28, 0, 2, 3, 5, 5, 4), stringsAsFactors = FALSE) # All students
df1 <- data.frame(Cat = c("CC", "Lab", "Sem", "Mentor", "Discussing", "Present", "Write", "Read"), Freq = c(7, 21, 0, 2, 2, 4, 5, 2), stringsAsFactors = FALSE) # Pos SE students
df1$Percent = round((df1$Freq / sum(df1$Freq)) * 100, 2)
df1$Cat <- factor(df1$Cat, levels = c("Sem", "CC", "Discussing", "Present", "Lab", "Read", "Mentor", "Write"), ordered = TRUE)
fig4a <- ggplot(df1, aes(x="", y=Percent, fill=Cat))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values = c("Sem" = "#BEBEBE", "CC" = "#D64051", "Discussing" = "#F68E5C", "Present" = "#FDE08C", "Lab" = "#FBF8C0", "Read" = "#E4EA9A", "Mentor" = "#99D094", "Write" = "#3089BE")) + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

#df2 <- data.frame(Cat = c("CC", "Lab", "Sem", "Mentor", "Discussing", "Present", "Write", "Read"), Freq = c(14, 16, 0, 7, 6, 3, 3, 7), stringsAsFactors = FALSE) # All students
df2 <- data.frame(Cat = c("CC", "Lab", "Sem", "Mentor", "Discussing", "Present", "Write", "Read"), Freq = c(11, 14, 0, 5, 3, 3, 3, 5), stringsAsFactors = FALSE) # Pos SE studnets
df2$Percent = round((df2$Freq / sum(df2$Freq)) * 100, 2)
df2$Cat <- factor(df2$Cat, levels = c("Sem", "CC", "Discussing", "Present", "Lab", "Read", "Mentor", "Write"), ordered = TRUE)
fig4b <- ggplot(df2, aes(x="", y=Percent, fill=Cat))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values = c("Sem" = "#BEBEBE", "CC" = "#D64051", "Discussing" = "#F68E5C", "Present" = "#FDE08C", "Lab" = "#FBF8C0", "Read" = "#E4EA9A", "Mentor" = "#99D094", "Write" = "#3089BE")) + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

fig4 = grid.arrange(fig4a, fig4b, nrow = 1)
plot(fig4)
ggsave(fig4a, file="~/Desktop/Fig4a_THISONE.svg", width = 2, height = 2)

# Years previous lab experience
mat = matrix(c(as.matrix(table(data_F$LabExp)), as.matrix(table(factor(data_M$LabExp, levels = 1:7)))), nrow = 2, dimnames = list("Sex" = c("F", "M"), "Experience" = c("0-2", "2-3", "3-4", "4-5", "5-6", "6-7", "7+")))

mat = matrix(rbind(c(9, 28, 2, 3, 5, 5, 4), c(14, 16, 7, 6, 3, 3, 7)), nrow = 2, dimnames = list("Q" = c("Exp", "Comf"), "Cat" = c("CC", "Lab", "Mentor", "Discussing", "Present", "Write", "Read")))
mat
round((mat/c(nF, nM)) * 100, 0)
chisq.test(mat)
prop.test(t(mat))

exp=28
comf=16
m = matrix(c(exp, comf, 56-exp, 56-comf), nrow = 2, dimnames = list("Q" = c("Exp", "Comf"), "Dim" = c("Yes", "No")))
prop.test(t(m))

```

There is a poor coorelation between students' self-reported experience with experiemental design and the total time spent previously in research labs upon entering graduate school.
```{r}
# Calculate correlations
c_exp = round(cor(data$ExperimetalDeignExperience, data$LabExp, method = "spearman"), 2)
c_comf = round(cor(data$ExperimetalDeignComfort, data$LabExp, method = "spearman"), 2)

# Print output
cat(paste("There is a Spearman correlation coefficient of ", c_exp, " between self-reported experience with experimental design and years of previous work in a research lab\n",
          "There is a Spearman correlation coefficient of ", c_comf, " between self-reported comfort with experimental design and years of previous work in a research lab\n", sep=""))

# Plot histograms
fig1bi <- ggplot(data, aes(x = ExperimetalDeignExperience)) + 
  geom_histogram(binwidth = 0.5, fill = "#174E94") + 
  theme_bw() +
  scale_x_continuous(breaks=c(1:5), limits=c(0.5,5.5)) + ylim(0, 40) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank())

fig1bii <- ggplot(data, aes(x = ExperimetalDeignComfort)) + 
  geom_histogram(binwidth = 0.5, fill = "#174E94") + 
  theme_bw() +
  scale_x_continuous(breaks=c(1:7), limits=c(0.5,7.5)) + ylim(0, 40) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank())

# Plot scatterplots
fig1ci <- ggplot(data, aes(x = ExperimetalDeignExperience, y = LabExp)) +
  geom_jitter(width = 0.25, height = 0.25, size = 2, color = "#808080") + 
  scale_x_continuous(breaks=c(1:5), limits=c(0.5,5.5)) + 
  scale_y_continuous(breaks=c(1:7), limits=c(0.5,7.5)) +
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank())

fig1cii <- ggplot(data, aes(x = ExperimetalDeignComfort, y = LabExp)) +
  geom_jitter(width = 0.25, height = 0.25, size = 2, color = "#808080") + 
  scale_x_continuous(breaks=c(1:7), limits=c(0.5,7.5)) + 
  scale_y_continuous(breaks=c(1:7), limits=c(0.5,7.5)) +
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank())

fig1bc = grid.arrange(fig1bi, fig1bii, fig1ci, fig1cii, nrow = 2)
plot(fig1bc)
ggsave(fig1bc, file="~/Desktop/Fig1BC.svg", width = 6, height = 4)


## BEDCI

c_se = round(cor((data_2017$Pre_CITotal/14)*100, data_2017$LabExp, method = "spearman"), 2)

# Plot histograms
fig2ci <- ggplot(data_2017, aes(x = Pre_CITotal)) + 
  geom_histogram(binwidth = 0.5, fill = "#174E94") + 
  theme_bw() +
  scale_x_continuous(breaks=c(5:12)) + 
  scale_y_continuous(breaks=seq(0, 10, 2), limits=c(0,10.5)) +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank())

fig2cii <- ggplot(data_2017, aes(x = (Pre_CITotal / 14) * 100, y = LabExp)) +
  geom_jitter(width = 0.25, height = 0.25, size = 2, color = "#174E94") + 
  scale_x_continuous(breaks=seq(40, 100, 20), limits=c(30, 90)) +  
  scale_y_continuous(breaks=c(1:7), limits=c(0.5,7.5)) +
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank())

#fig2c = grid.arrange(fig2ci, fig2cii, nrow = 2)
#plot(fig2c)
ggsave(fig2cii, file="Fig2C_new.svg", width = 2, height = 2)

```

***

# Figure 2: Students significantly improved in many aspects of research skills self-efficacy during their first semester of graduate school

Student-reported research skill self-efficacy changed over the first semester of graduate school.
```{r}
# Split data by responses to self-efficacy questionaire before and after the first semester of graduate school
SE_pre = data[,14:27]
SE_post = data[,28:41]
SE_pre$LabExp = as.character(data$LabExp)
SE_post$LabExp = as.character(data$LabExp)
# Melt responses
mSE_pre = melt(SE_pre)
mSE_post = melt(SE_post)

# Add question number label to each pre / post array
mSE_pre$Question = rep(c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), each = numStudents)
mSE_pre$Test = "Pre"
mSE_post$Question = rep(c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), each = numStudents)
mSE_post$Test = "Post"

# Change labels to strings for categorical plotting
mSE_pre[mSE_pre$value==1,"value"] = "a1" # Not at all, pre-test
mSE_pre[mSE_pre$value==2,"value"] = "b1" # A little, pre-test
mSE_pre[mSE_pre$value==3,"value"] = "c1" # A moderate amount, pre-test
mSE_pre[mSE_pre$value==4,"value"] = "d1" # A lot, pre-test
mSE_pre[mSE_pre$value==5,"value"] = "e1" # A great deal, pre-test

mSE_post[mSE_post$value==1,"value"] = "a2" # Not at all, post-test
mSE_post[mSE_post$value==2,"value"] = "b2" # A little, post-test
mSE_post[mSE_post$value==3,"value"] = "c2" # A moderate amount, post-test
mSE_post[mSE_post$value==4,"value"] = "d2" # A lot, post-test
mSE_post[mSE_post$value==5,"value"] = "e2" # A great deal, post-test

mSE_pre_total = mSE_pre
mSE_pre_total$LabExp = as.character(0.5)
mSE_pre2 = rbind(mSE_pre_total, mSE_pre)

### FIG 1D: Lab exp v. total SE
# Stacked bar chart
fig1di <- ggplot(mSE_pre2, aes(Test)) + 
  geom_bar(aes(fill=value), position = "fill") + facet_grid(~ LabExp) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("a1" = "#DAE3F3", "b1" = "#B4C7E7", "c1" = "#8FAADC", "d1" = "#2F5597", "e1" = "#203864", "a2" = "#FBE5D6", "b2" = "#F8CBAD", "c2" = "#F4B183", "d2" = "#C55A11", "e2" = "#843C0C" )) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(axis.title.x=element_blank(), 
       axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        legend.position="none",
        strip.background = element_blank(), 
        strip.text = element_blank())

plot(fig1di)
ggsave(fig1di, filename="FIG1D.svg", width = 4, height = 3)



# Combine pre- and post-test dataframes for plotting
mSE <- rbind(mSE_pre, mSE_post)

# Order variables for plotting (by factors)
#mSE$Question <- factor(mSE$Question, levels = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), ordered = TRUE)
mSE$Question <- factor(mSE$Question, levels = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q14", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13"), ordered = TRUE)
mSE$Test <- factor(mSE$Test, levels = c("Pre", "Post"), ordered = TRUE)

# Create stacked bar chart for each question, pre- and post-test
fig2bi <- ggplot(mSE, aes(Test)) + 
  geom_bar(aes(fill=value), position = "fill") + facet_grid(~ Year) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("a1" = "#DAE3F3", "b1" = "#B4C7E7", "c1" = "#8FAADC", "d1" = "#2F5597", "e1" = "#203864", "a2" = "#FBE5D6", "b2" = "#F8CBAD", "c2" = "#F4B183", "d2" = "#C55A11", "e2" = "#843C0C" )) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        legend.position="none",
        strip.background = element_blank(), 
        strip.text = element_blank())

mSE_total = data.frame(Test = rep(c("Pre", "Post"), 5), Lab = row.names(table(mSE$value)), Freq = as.vector(table(mSE$value)), stringsAsFactors = FALSE)
mSE_total$Test <- factor(mSE_total$Test, levels = c("Pre", "Post"), ordered = TRUE)

# Stacked bar chart
fig2bii <- ggplot(mSE_total, aes(x=Test, y=Freq)) + 
  geom_bar(aes(fill=Lab), stat = "identity", position = "fill") +
  theme_bw() + 
  scale_fill_manual("legend", values = c("a1" = "#DAE3F3", "b1" = "#B4C7E7", "c1" = "#8FAADC", "d1" = "#2F5597", "e1" = "#203864", "a2" = "#FBE5D6", "b2" = "#F8CBAD", "c2" = "#F4B183", "d2" = "#C55A11", "e2" = "#843C0C" )) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none", axis.ticks = element_blank())


plot(fig2bi)
plot(fig2bii)

fig2b = grid.arrange(fig2bi, fig2bii, nrow = 1, widths = c(5, 1))
ggsave(fig2b, filename="FIG2B.svg", width = 4, height = 3)
```

To detect statistically significant shifts in student responses to each question from the pre-test to the post-test, we used the Wilcoxon signed-rank test. This statistical test leverages the paired nature of the data while treating responses as categorical variables (not assuming that there is an equal, linear distance between all Likert scale responses).
```{r}
# Function to perform the Wilcoxon signed-rank test, comparing student responses to each question before and after their first semester of graduate school
wilcoxonSignedRankTest <- function(dat, Q) {
  
# Get the data of interest for each question
  pre = dat[,Q+13]
  post = dat[,(Q+27)]
  
  # Perform wilcoxon signed-rank test for significance
  wilcox.test(pre, post, paired=TRUE, alternative = "two.sided", exact=FALSE)
}

# Calculate the p-value for each question and save to an output table
Items = c("Understand contemporary concepts in your field", "Make use of the primary scientific research literature in your field (e.g., journal articles)", "Identify a specific question for investigation based on the research in your field", "Formulate a research hypothesis based on a specific question", "Design an experiment or theoretical test of the hypothesis", "Understand the importance of 'controls' in research", "Observe and collect data", "Statistically analyze data", "Interpret data by relating results to the original hypothesis", "Reformulate your original research hypothesis (as appropriate)", "Relate your results to the 'bigger picture' in your field", "Orally communicate the results of research projects", "Write a research paper for publication", "Think independently", "TOTAL")
sigOut = data.frame(Item = Items, Question = 1:15, V = rep(0, 15), pValue = rep(0, 15), Significance = rep("", 15), stringsAsFactors = FALSE)
for (i in 1:15) {
  if (i < 15) {
    wTest = wilcoxonSignedRankTest(data, i)
  } else { # Total
    wTest = wilcox.test(melt(data[,14:27])$value, melt(data[,28:41])$value, paired=TRUE, alternative = "two.sided", exact=FALSE)
  }
  sigOut$V[i] = wTest$statistic
  sigOut$pValue[i] = round(wTest$p.value, 4)
  if (wTest$p.value < 0.001) {
    sigOut$Significance[i] = "***"
  } else if (wTest$p.value < 0.01) {
    sigOut$Significance[i] = "**"
  } else if (wTest$p.value < 0.05) {
    sigOut$Significance[i] = "*"
  }
}

# Print signficance table
print(sigOut) # Table S1
```

***

# Figure 3: Students improved their performance of experimental design over their first semester of graduate school

Students improved in their concept inventory total score over their first semester of graduate school.
```{r}
# Note that can only use 2017 data for BEDCI score analysis
data_2017 = data[data$Year == "2017", ]
numStudents_2017 = nrow(data_2017) # Calculate number of students in cohort to be analyzed (2017)
# Print output
cat(paste("There are ", numStudents_2017, " student responses contained in the following analyses.\n", sep ="")) 

# Calculate scores (in percent)
pre_score = data.frame(Score = (data_2017$Pre_CITotal / 14) * 100, Test = "Pre", stringsAsFactors = FALSE)
post_score = data.frame(Score = (data_2017$Post_CITotal / 14) * 100, Test = "Post", stringsAsFactors = FALSE)
df = rbind(pre_score, post_score)

# Order for plotting
df$Test <- factor(df$Test, levels = c('Pre','Post'), ordered = TRUE)

# Create violin plot
fig3a <- ggplot(df, aes(x = Test, y = Score)) + 
  geom_violin(draw_quantiles = c(0.5), scale = "width", aes(fill = Test)) + 
  geom_jitter(height = 3, width = 0.1) + 
  scale_fill_manual(values = c("#174E94", "#EE7D31")) +
  scale_y_continuous(breaks = seq(40, 100, 20), labels = seq(40, 100, 20)) + 
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

plot(fig3a)
ggsave(fig3a, filename="FIG3A.svg", width = 2, height = 3)
```

To detect statistically significant shifts in student performance on the BEDCI assessment of experimental design, we used the Wilcoxon signed-rank test. This statistical test leverages the paired nature of the data.
```{r}
# Perform wilcoxon signed-rank test
wTest = wilcox.test(data_2017$Pre_CITotal, data_2017$Post_CITotal, paired=TRUE, alternative = "two.sided", exact = FALSE)

# Determine significance level
sig1 = "is NOT a statistically significant difference"
sig2 = ""
if (wTest$p.value < 0.001) {
  sig1 = "IS a statistically significant difference"
  sig2 = "***"
} else if (wTest$p.value < 0.01) {
  sig1 = "IS a statistically significant difference"
  sig2 = "**"
} else if (wTest$p.value < 0.05) {
  sig1 = "IS a statistically significant difference"
  sig2 = "*"
}

# Print output 
cat(paste("By a Wilcoxon signed-rank test, there ", sig1, " between student performance on the BEDCI concept inventory before and after their first semester of graduate school (V = ", wTest$statistic, ", p = ", round(wTest$p.value, 4), sig2, ")", sep=""))
```

Students significantly improved on research skills related to controls, hypothesis generation, biological variation, and accuracy. 
```{r}
# Function for calculating standard error of the mean
stderr_perc <- function(x, na.rm=FALSE) {
  if (na.rm) x <- na.omit(x)
  y = (x / numStudents_2017) * 100
  #sqrt(var(y)/length(y))
  sqrt(var(y))
}

# Make data frame suitable for plotting
Q = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14") # Order of questions by subject matter
mCI_pre = data.frame(Question = Q, Test = "Pre", Score = (colSums(data_2017[,42:55]) / numStudents_2017) * 100, SEM = apply(as.matrix(data_2017[,42:55]), 2, stderr_perc), stringsAsFactors = FALSE) # Calculate mean score for each question on the pre-test
mCI_post = data.frame(Question = Q, Test = "Post", Score = (colSums(data_2017[,57:70]) / numStudents_2017) * 100, SEM = apply(as.matrix(data_2017[,42:55]), 2, stderr_perc), stringsAsFactors = FALSE) # Calculate mean score for each question on the post-test

# Combine
mCI = rbind(mCI_pre, mCI_post)

# Reorder for plotting
mCI$Question <- factor(mCI$Question, levels = c('Q1', 'Q5', 'Q2', 'Q9', 'Q3', 'Q10', 'Q4', 'Q6', 'Q14', 'Q7', 'Q12', 'Q8', 'Q13', 'Q11'), ordered = TRUE)
mCI$Test <- factor(mCI$Test, levels = c('Pre','Post'), ordered = TRUE)

# Create bar chart
fig3b <- ggplot(mCI, aes(x = Question, y = Score, fill = Test, group = Test)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin=Score-SEM, ymax=Score+SEM), colour="black", width = 0.3, position = position_dodge(1)) +
  scale_fill_manual(values = c("#174E94", "#EE7D31")) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

plot(fig3b)
ggsave(fig3b, filename="FIG3B.svg", width = 5, height = 3)
```

To identify those components of experimental design on which students most improved over the semester, we leveraged the paired nature of the data using McNemar’s test on the dichotomous trait of responses on each BEDCI question. 
```{r}
# Function to perform McNemar's chi-squared test for each question on the BEDCI pre- and post-tests
mcNemarChiSquaredTest <- function(dat, Q) { 
  
  # Get relevant data for each question
  pre = dat[,(Q+41)]
  post = dat[,(Q+56)]
  
  # Calculate values to populate matrix
  c_c = sum(pre + post == 2) # Correct, correct
  i_c = sum(pre - post == -1) # Incorrect, correct
  c_i = sum(pre - post == 1) # Correct, incorrect
  i_i = sum(pre + post == 0) # Incorrect, incorrect
  
  # Create confusion matrix
  mat = matrix(c(c_c, i_c, c_i, i_i), nrow = 2, dimnames = list("Pre" = c("Correct", "Incorrect"), "Post" = c("Correct", "Incorrect")))
  
  # Calculate significance
  mcnemar.test(mat)
}

# Calculate the p-value for each question and save to an output table
coreConcepts = c("Controls", "", "Hypotheses", "", "Biological variation", "", "Accuracy", "Extraneous factors", "", "Independent sampling", "", "Random sampling", "", "Purpose of experiments")
questions = c(1, 5, 2, 9, 3, 10, 4, 6, 14, 7, 12, 8, 13, 11) # Questions ordered by subject
sigOut = data.frame(CoreConcept = coreConcepts, Question = questions, Chi = rep(0, 14), pValue = rep(0, 14), Significance = rep("", 14), stringsAsFactors = FALSE)
i = 1 # Iterate over every row of output
for (q in questions) {
  mnTest = mcNemarChiSquaredTest(data_2017, q)
  sigOut$Chi[i] = round(mnTest$statistic, 2)
  sigOut$pValue[i] = round(mnTest$p.value, 4)
  if (mnTest$p.value < 0.001) {
    sigOut$Significance[i] = "***"
  } else if (mnTest$p.value < 0.01) {
    sigOut$Significance[i] = "**"
  } else if (mnTest$p.value < 0.05) {
    sigOut$Significance[i] = "*"
  }
  i = i + 1 # Increment counter
}

# Print signficance table
print(sigOut) # Table S3
```

***

# Figure 4: Male students are more confident but less skilled in experimental design than female students at the beginning of the semester, but this gender gap disappears by the end of the course.

There was no difference in gender between the pre- and post-test assessments
```{r}
# Split data by sex, counting students
numFStudents_2017 = sum(data_2017$Sex == "Female")
numMStudents_2017 = sum(data_2017$Sex == "Male")

# Calculate means and standard deviations for pre- and post-test by sex
gSE = data.frame(Test = rep(c("Pre", "Post"), 2), Gender = rep(c("Female", "Male"), each = 2), Mean = rep(0, 4), SD = rep(0, 4), stringsAsFactors = FALSE)

gSE$Mean[1] = mean((data_2017[data_2017$Sex == "Female", "Pre_CITotal"] / 14) * 100)
gSE$SD[1] = sd((data_2017[data_2017$Sex == "Female", "Pre_CITotal"] / 14) * 100)

gSE$Mean[2] = mean((data_2017[data_2017$Sex == "Female", "Post_CITotal"] / 14) * 100)
gSE$SD[2] = sd((data_2017[data_2017$Sex == "Female", "Post_CITotal"] / 14) * 100)

gSE$Mean[3] = mean((data_2017[data_2017$Sex == "Male", "Pre_CITotal"] / 14) * 100)
gSE$SD[3] = sd((data_2017[data_2017$Sex == "Male", "Pre_CITotal"] /  14) * 100)

gSE$Mean[4] = mean((data_2017[data_2017$Sex == "Male", "Post_CITotal"] / 14) * 100)
gSE$SD[4] = sd((data_2017[data_2017$Sex == "Male", "Post_CITotal"] / 14) * 100)

# Order variables for plotting
gSE$Test <- factor(gSE$Test, levels = c("Pre", "Post"), ordered = TRUE)

fig4a <- ggplot(gSE, aes(x = Test, y = Mean, fill = Gender)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = Mean - SD, ymax = Mean + SD), width = 0.3, position = position_dodge(0.9)) +
  scale_fill_manual(values = c("magenta4", "green4")) +
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

plot(fig4a)
ggsave(fig4a, file="Fig4A.svg", width = 2, height = 5)
```

To compare the overall BEDCI scores among male and female students, we used the Student’s t-test.
```{r}
# Perform t-tests for pairwise combinations of tests and genders
fpre_mpre = t.test(x = (data_2017[data_2017$Sex == "Female", "Pre_CITotal"] / 14) * 100, y = (data_2017[data_2017$Sex == "Male", "Pre_CITotal"] / 14) * 100, alternative = "two.sided")
fpre_fpost = t.test(x = (data_2017[data_2017$Sex == "Female", "Pre_CITotal"] / 14) * 100, y = (data_2017[data_2017$Sex == "Female", "Post_CITotal"] / 14) * 100, alternative = "two.sided")
fpost_mpost = t.test(x = (data_2017[data_2017$Sex == "Female", "Post_CITotal"] / 14) * 100, y = (data_2017[data_2017$Sex == "Male", "Post_CITotal"] / 14) * 100, alternative = "two.sided")
mpre_mpost = t.test(x = (data_2017[data_2017$Sex == "Male", "Post_CITotal"] / 14) * 100, y = (data_2017[data_2017$Sex == "Male", "Post_CITotal"] / 14) * 100, alternative = "two.sided")

# Create variables to hold results
sigOut = data.frame(X = c("Female, Pre-test", "Female, Pre-test", "Female, Post-test", "Male, Pre-test"), Y = c("Male, Pre-test", "Female, Post-test", "Male, Post-test", "Male, Post-test"), t = rep(0, 4), pValue = rep(0, 4), Significance = rep("", 4), stringsAsFactors = FALSE)

# Enter test results into data frame
sigOut$t[1] = fpre_mpre$statistic # Female, pre-test v male, pre-test
sigOut$pValue[1] = fpre_mpre$p.value

sigOut$t[2] = fpre_fpost$statistic # Female, pre-test v female, post-test
sigOut$pValue[2] = fpre_fpost$p.value

sigOut$t[3] = fpost_mpost$statistic # Female, post-test v male, post-test
sigOut$pValue[3] = fpost_mpost$p.value

sigOut$t[4] = mpre_mpost$statistic # Male, pre-test v male, post-test
sigOut$pValue[4] = mpre_mpost$p.value

for (i in 1:4) {
  if (sigOut$pValue[i] < 0.001) {
    sigOut$Significance[i] = "***"
  } else if (sigOut$pValue[i] < 0.01) {
    sigOut$Significance[i] = "**"
  } else if (sigOut$pValue[i] < 0.05) {
    sigOut$Significance[i] = "*"
  }
}

# Print statistical test results
print(sigOut)
```

Female students are report lower-self efficacy at the beginning of the class compared to the end.
```{r}
# Get responses for each of the five Likert scale responses for Question 5 on the self-efficacy survey ("Design an experiment or theoretical test of the hypothesis") on pre-test
fQ5_pre = (as.vector(table(factor(data_2017[(data_2017$Sex == "Female"),"Pre_Q5"], levels = 1:5))) / nrow(data_2017[(data_2017$Sex == "Female"),])) * 100
mQ5_pre = (as.vector(table(factor(data_2017[(data_2017$Sex == "Male"),"Pre_Q5"], levels = 1:5))) / nrow(data_2017[(data_2017$Sex == "Male"),])) * 100
Q5_pre_freq = c(fQ5_pre, mQ5_pre)

# Create data frame with frequency of responses (pre-test values)
Q5_pre = data.frame(lev = rep(1:5, 2), value = Q5_pre_freq, gender = rep(c("Female", "Male"), each = 5), col = as.character(1:10), stringsAsFactors = FALSE)
Q5_pre$col <- factor(Q5_pre$col , levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"), ordered = TRUE)
Q5_pre$gender <- factor(Q5_pre$gender, levels = c("Female", "Male"), ordered = TRUE)

# Get responses for each of the five Likert scale responses for Question 5 on the self-efficacy survey ("Design an experiment or theoretical test of the hypothesis") on post-test
fQ5_post = (as.vector(table(factor(data_2017[(data_2017$Sex == "Female"),"Post_Q5"], levels = 1:5))) / nrow(data_2017[(data_2017$Sex == "Female"),])) * 100
mQ5_post = (as.vector(table(factor(data_2017[(data_2017$Sex == "Male"),"Post_Q5"], levels = 1:5))) / nrow(data_2017[(data_2017$Sex == "Male"),])) * 100
Q5_post_freq = c(fQ5_post, mQ5_post)

# Create data frame with frequency of responses (post-test values)
Q5_post = data.frame(lev = rep(1:5, 2), value = Q5_post_freq, gender = rep(c("Female", "Male"), each = 5), col = as.character(1:10), stringsAsFactors = FALSE)
Q5_post$col <- factor(Q5_post$col , levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"), ordered = TRUE)
Q5_post$gender <- factor(Q5_post$gender, levels = c("Female", "Male"), ordered = TRUE)

# Histogram
fig4bi <- ggplot(Q5_pre, aes(x=lev, y=value)) +
  geom_bar(aes(fill = col), stat = "identity", position = position_dodge()) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  scale_x_continuous(breaks=c(1:5) ,limits=c(0.5,5.5)) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

# Stacked bar chart
fig4bii <- ggplot(Q5_pre, aes(x=gender, y=value)) + 
  geom_bar(aes(fill=col), stat = "identity", position = "fill") +
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none", axis.ticks = element_blank())

# Histogram
fig4biii <- ggplot(Q5_post, aes(x=lev, y=value)) +
  geom_bar(aes(fill = col), stat = "identity", position = position_dodge()) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  scale_x_continuous(breaks=c(1:5) ,limits=c(0.5,5.5)) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

# Stacked bar chart
fig4biv <- ggplot(Q5_post, aes(x=gender, y=value)) + 
  geom_bar(aes(fill=col), stat = "identity", position = "fill") +
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none", axis.ticks = element_blank())

fig4b_top = grid.arrange(fig4bi, fig4bii, nrow = 1, widths = c(3, 1))
plot(fig4b_top)
ggsave(fig4b_top, file="Fig4Bi.svg", width = 5, height = 3)

fig4b_bottom = grid.arrange(fig4biii, fig4biv, nrow = 1, widths = c(3, 1))
plot(fig4b_bottom)
ggsave(fig4b_bottom, file="Fig4Bii.svg", width = 5, height = 3)

```

Do the same for 2018
```{r}
# Get responses for each of the five Likert scale responses for Question 5 on the self-efficacy survey ("Design an experiment or theoretical test of the hypothesis") on pre-test
data_2018 = data[data$Year == "2018", ]
fQ5_pre = (as.vector(table(factor(data_2018[(data_2018$Sex == "Female"),"Pre_Q5"], levels = 1:5))) / nrow(data_2018[(data_2018$Sex == "Female"),])) * 100
mQ5_pre = (as.vector(table(factor(data_2018[(data_2018$Sex == "Male"),"Pre_Q5"], levels = 1:5)))/ nrow(data_2018[(data_2018$Sex == "Male"),])) * 100
Q5_pre_freq = c(fQ5_pre, mQ5_pre)

# Create data frame with frequency of responses (pre-test values)
Q5_pre = data.frame(lev = rep(1:5, 2), value = Q5_pre_freq, gender = rep(c("Female", "Male"), each = 5), col = as.character(1:10), stringsAsFactors = FALSE)
Q5_pre$col <- factor(Q5_pre$col , levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"), ordered = TRUE)
Q5_pre$gender <- factor(Q5_pre$gender, levels = c("Female", "Male"), ordered = TRUE)

# Get responses for each of the five Likert scale responses for Question 5 on the self-efficacy survey ("Design an experiment or theoretical test of the hypothesis") on post-test
fQ5_post = (as.vector(table(factor(data_2017[(data_2017$Sex == "Female"),"Post_Q5"], levels = 1:5))) / nrow(data_2018[(data_2018$Sex == "Female"),])) * 100
mQ5_post = (as.vector(table(factor(data_2017[(data_2017$Sex == "Male"),"Post_Q5"], levels = 1:5))) / nrow(data_2018[(data_2018$Sex == "Male"),])) * 100
Q5_post_freq = c(fQ5_post, mQ5_post)

# Create data frame with frequency of responses (post-test values)
Q5_post = data.frame(lev = rep(1:5, 2), value = Q5_post_freq, gender = rep(c("Female", "Male"), each = 5), col = as.character(1:10), stringsAsFactors = FALSE)
Q5_post$col <- factor(Q5_post$col , levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"), ordered = TRUE)
Q5_post$gender <- factor(Q5_post$gender, levels = c("Female", "Male"), ordered = TRUE)

# Histogram
fig4ci <- ggplot(Q5_pre, aes(x=lev, y=value)) +
  geom_bar(aes(fill = col), stat = "identity", position = position_dodge()) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  scale_x_continuous(breaks=c(1:5) ,limits=c(0.5,5.5)) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

# Stacked bar chart
fig4cii <- ggplot(Q5_pre, aes(x=gender, y=value)) + 
  geom_bar(aes(fill=col), stat = "identity", position = "fill") +
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none", axis.ticks = element_blank())

# Histogram
fig4ciii <- ggplot(Q5_post, aes(x=lev, y=value)) +
  geom_bar(aes(fill = col), stat = "identity", position = position_dodge()) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  scale_x_continuous(breaks=c(1:5) ,limits=c(0.5,5.5)) #+ 
#  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

# Stacked bar chart
fig4civ <- ggplot(Q5_post, aes(x=gender, y=value)) + 
  geom_bar(aes(fill=col), stat = "identity", position = "fill") +
  theme_bw() + 
  scale_fill_manual("legend", values = c("1" = "#D5ACD9", "2" = "#BE7DC4", "3" = "#9A33A2", "4" = "#67006F", "5" = "#420047", "6" = "#ACD9AC", "7" = "#7DC47D", "8" = "#33A233", "9" = "#006F00", "10" = "#004700")) + 
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none", axis.ticks = element_blank())

fig4c_top = grid.arrange(fig4ci, fig4cii, nrow = 1, widths = c(3, 1))
plot(fig4c_top)
ggsave(fig4c_top, file="Fig4Ci.svg", width = 5, height = 3)

fig4c_bottom = grid.arrange(fig4ciii, fig4civ, nrow = 1, widths = c(3, 1))
plot(fig4c_bottom)
ggsave(fig4c_bottom, file="Fig4Cii.svg", width = 5, height = 3)

```

Significance was determined with ordinal linear regressions where pre- and post-test ratings were the response variables and gender was the predictive factor.
```{r}
# Function to calculate the p-value of every factor on the post-test score
ordLogReg <- function(dat, Q, test) {
  
  # Get relevant data for each question
  pre = dat[,(Q+13)]
  post = dat[,(Q+27)]
  
  # Create data frame including pre-test score, post-test score, gender, and years of research experience
  mat = data.frame(Pre = pre, Post = post, Gender = dat$Sex, stringsAsFactors = FALSE)
  
  # Reorder 
  mat$Gender <- factor(mat$Gender, levels=c("Female", "Male"), ordered=TRUE)
  
  if (test == "pre") {
    summary(glm(Pre ~ Gender, data = mat))
  } else if (test == "post") {
    summary(glm(Post ~ Gender, data = mat))
  } else {
    cat("Please enter either 'pre' or 'post' as a selection of the test to correctly use this function.\n")
  }
}

# Pre-test
# Perform test for question 5 pre-test data
ordLogRegTest = as.vector(ordLogReg(data_2017, 5, "pre")$coefficients)[c(6,8)] # t value and p value

# Significance
sig1 = "is NOT a statistically significant difference"
sig2 = ""

if (ordLogRegTest[2] < 0.001) {
  sig1 = "IS a statistically significant difference"
  sig2 = "***"
} else if (ordLogRegTest[2] < 0.01) {
  sig1 = "IS a statistically significant difference"
  sig2 = "**"
} else if (ordLogRegTest[2] < 0.05) {
  sig1 = "IS a statistically significant difference"
  sig2 = "*"
}

# Print output 
cat(paste("By ordinal logistic regression, there ", sig1, " between male and female student responses on the self-efficacy research skills survey about experimental design before their first semester of graduate school (t = ", round(ordLogRegTest[1], 2), ", p = ", round(ordLogRegTest[2], 4), sig2, ")\n", sep=""))

# Post-test
# Perform test for question 5 post-test data
ordLogRegTest = as.vector(ordLogReg(data_2017, 5, "post")$coefficients)[c(6,8)] # t value and p value

# Significance
sig1 = "is NOT a statistically significant difference"
sig2 = ""

if (ordLogRegTest[2] < 0.001) {
  sig1 = "IS a statistically significant difference"
  sig2 = "***"
} else if (ordLogRegTest[2] < 0.01) {
  sig1 = "IS a statistically significant difference"
  sig2 = "**"
} else if (ordLogRegTest[2] < 0.05) {
  sig1 = "IS a statistically significant difference"
  sig2 = "*"
}

# Print output 
cat(paste("By ordinal logistic regression, there ", sig1, " between male and female student responses on the self-efficacy research skills survey about experimental design after their first semester of graduate school (t = ", round(ordLogRegTest[1], 2), ", p = ", round(ordLogRegTest[2], 4), sig2, ")\n", sep=""))

# Do the same for 2018
# Pre-test
# Perform test for question 5 pre-test data
ordLogRegTest = as.vector(ordLogReg(data_2018, 5, "pre")$coefficients)[c(6,8)] # t value and p value

# Significance
sig1 = "is NOT a statistically significant difference"
sig2 = ""

if (ordLogRegTest[2] < 0.001) {
  sig1 = "IS a statistically significant difference"
  sig2 = "***"
} else if (ordLogRegTest[2] < 0.01) {
  sig1 = "IS a statistically significant difference"
  sig2 = "**"
} else if (ordLogRegTest[2] < 0.05) {
  sig1 = "IS a statistically significant difference"
  sig2 = "*"
}

# Print output 
cat(paste("By ordinal logistic regression, there ", sig1, " between male and female student responses on the self-efficacy research skills survey about experimental design before their first semester of graduate school (t = ", round(ordLogRegTest[1], 2), ", p = ", round(ordLogRegTest[2], 4), sig2, ")\n", sep=""))

# Post-test
# Perform test for question 5 post-test data
ordLogRegTest = as.vector(ordLogReg(data_2018, 5, "post")$coefficients)[c(6,8)] # t value and p value

# Significance
sig1 = "is NOT a statistically significant difference"
sig2 = ""

if (ordLogRegTest[2] < 0.001) {
  sig1 = "IS a statistically significant difference"
  sig2 = "***"
} else if (ordLogRegTest[2] < 0.01) {
  sig1 = "IS a statistically significant difference"
  sig2 = "**"
} else if (ordLogRegTest[2] < 0.05) {
  sig1 = "IS a statistically significant difference"
  sig2 = "*"
}

# Print output 
cat(paste("By ordinal logistic regression, there ", sig1, " between male and female student responses on the self-efficacy research skills survey about experimental design after their first semester of graduate school (t = ", round(ordLogRegTest[1], 2), ", p = ", round(ordLogRegTest[2], 4), sig2, ")\n", sep=""))

```

***

# Table S1: There is no difference in the population of students in 2017 and 2018.
```{r}
# Sex
sexF_2017 = sum(data_2017$Sex == "Female")
data_2018 = data[(data$Year == "2018") & !is.na(data$Sex),]
numStudents_2018 = nrow(data_2018)
sexF_2018 = sum(data_2018$Sex  == "Female")

mat = matrix(c(sexF_2017, sexF_2018, numStudents_2017 - sexF_2017, numStudents_2018 - sexF_2018), nrow = 2, dimnames = list("Year" = c("2017", "2018"), "Sex" = c("Female", "Male")))
prop.test(t(mat), correct=FALSE)

mat = matrix(c(6, 7, 64, 59), nrow = 2, dimnames = list("Year" = c("2017", "2018"), "Race" = c("URM", "nonURM")))
prop.test(t(mat), correct=FALSE)

# Years previous lab experience
mat = matrix(c(as.matrix(table(data_2017$LabExp)), as.matrix(table(factor(data_2018$LabExp, levels = 1:7)))), nrow = 2, dimnames = list("Year" = c("2017", "2018"), "Experience" = c("0-2", "2-3", "3-4", "4-5", "5-6", "6-7", "7+")))
             
chisq.test(mat)

# Degree
mat = matrix(c(colSums(data_2017[,3:9]), colSums(data_2018[,3:9])), nrow = 7, dimnames = list("Degree" = c("Biology", "Chemistry", "Engineering", "Math", "Physics", "CompSci", "Other"), "Year" = c("2017", "2018")))
             
chisq.test(mat)


mat = matrix(c(0, 5, 61, 0, 1, 0, 3, 4, 3, 47, 2, 0, 1, 9), nrow = 7, dimnames = list("Program" = c("BPH", "BIG", "BBS", "BP", "CB", "SB", "V"), "Year" = c("2017", "2018")))
             
chisq.test(mat)

# ED Experience
mat = matrix(c(as.matrix(table(data_2017$ExperimetalDeignExperience)), as.matrix(table(data_2018$ExperimetalDeignExperience))), nrow = 5, dimnames = list("Experience" = c("1", "2", "3", "4", "5"), "Year" = c("2017", "2018")))

wilcox.test(x = data_2017$ExperimetalDeignExperience, y = data_2018$ExperimetalDeignExperience, alternative = "two.sided")

# ED Comfort
mat = matrix(c(as.matrix(table(data_2017$ExperimetalDeignComfort)), as.matrix(table(data_2018$ExperimetalDeignComfort))), nrow = 7, dimnames = list("Comfort" = c("1", "2", "3", "4", "5", "6", "7"), "Year" = c("2017", "2018")))

wilcox.test(x = data_2017$ExperimetalDeignComfort, y = data_2018$ExperimetalDeignComfort, alternative = "two.sided")

# Total self-efficacy (pre)
wilcox.test(x = melt(data_2017[,14:27])$value, y = melt(data_2018[,14:27])$value, alternative = "two.sided")

# Total self-efficacy (post)
wilcox.test(x = melt(data_2017[,28:41])$value, y = melt(data_2018[,28:41])$value, alternative = "two.sided")

# Total self-efficacy (delta)
wilcox.test(x = (melt(data_2017[,28:41])$value - melt(data_2017[,14:27])$value), y = (melt(data_2018[,28:41])$value - melt(data_2018[,14:27])$value), alternative = "two.sided")

# By question self-efficacy
for (q in 1:14) {
  
  # pre
  #X = data_2017[,q+13]
  #Y = data_2018[,q+13]
  
  # post
  #X = data_2017[,q+27]
  #Y = data_2018[,q+27]
  
  # delta
  X = data_2017[,q+27] - data_2017[,q+13]
  Y = data_2018[,q+27] - data_2018[,q+13]
  
  w = wilcox.test(x = X, y = Y, alternative = "two.sided")
  print(paste("Question ", q, sep=""))
  print(w$p.value)
  
}

```
# Table S1: There is no difference in the population of students in 2017 and 2018.
```{r}
#Race
mat = matrix(c(6, 7, 57, 66), nrow = 2, dimnames = list("Sex" = c("F", "M"), "Race" = c("URM", "nonURM")))
prop.test(t(mat), correct=FALSE)

data_F = data[data$Sex == "Female", ]
data_F = data_F[!is.na(data_F$Sex),]
data_M = data[data$Sex == "Male", ]
data_M = data_F[!is.na(data_M$Sex),]

nF = nrow(data_F)
nM = nrow(data_M)

# Years previous lab experience
mat = matrix(c(as.matrix(table(data_F$LabExp)), as.matrix(table(factor(data_M$LabExp, levels = 1:7)))), nrow = 2, dimnames = list("Sex" = c("F", "M"), "Experience" = c("0-2", "2-3", "3-4", "4-5", "5-6", "6-7", "7+")))
mat
round((mat/c(nF, nM)) * 100, 0)
chisq.test(mat)

# Degree
mat = matrix(c(colSums(data_F[,3:9]), colSums(data_M[,3:9])), nrow = 7, dimnames = list("Degree" = c("Biology", "Chemistry", "Engineering", "Math", "Physics", "CompSci", "Other"), "Sex" = c("F", "M")))
mat
round((mat/c(nF, nM)) * 100, 0)  
chisq.test(mat)


mat = matrix(c(2, 4, 50, 1, 0, 1, 5, 2, 4, 58, 1, 1, 0, 7), nrow = 7, dimnames = list("Program" = c("BPH", "BIG", "BBS", "BP", "CB", "SB", "V"), "Sex" = c("F", "M")))
             
chisq.test(mat)

# ED Experience
mat = matrix(c(as.matrix(table(data_F$ExperimetalDeignExperience)), as.matrix(table(data_M$ExperimetalDeignExperience))), nrow = 5, dimnames = list("Experience" = c("1", "2", "3", "4", "5"), "Sex" = c("F", "M")))
mat
round((mat/c(nF, nM)) * 100, 0)  

wilcox.test(x = data_2017$ExperimetalDeignExperience, y = data_2018$ExperimetalDeignExperience, alternative = "two.sided")

# ED Comfort
mat = matrix(c(as.matrix(table(data_F$ExperimetalDeignComfort)), as.matrix(table(data_M$ExperimetalDeignComfort))), nrow = 7, dimnames = list("Comfort" = c("1", "2", "3", "4", "5", "6", "7"), "Sex" = c("F", "M")))
mat
round((mat/c(nF, nM)) * 100, 0) 
wilcox.test(x = data_2017$ExperimetalDeignComfort, y = data_2018$ExperimetalDeignComfort, alternative = "two.sided")

# Total self-efficacy (pre)
wilcox.test(x = melt(data_F[,14:27])$value, y = melt(data_M[,14:27])$value, alternative = "two.sided")

# Total self-efficacy (post)
wilcox.test(x = melt(data_F[,28:41])$value, y = melt(data_M[,28:41])$value, alternative = "two.sided")

# Total self-efficacy (delta)
wilcox.test(x = (melt(data_F[,28:41])$value - melt(data_F[,14:27])$value), y = (melt(data_M[,28:41])$value - melt(data_M[,14:27])$value), alternative = "two.sided")

# By question self-efficacy
for (q in 1:14) {
  
  # pre
  #X = data_F[,q+13]
  #Y = data_M[,q+13]
  
  # post
  #X = data_F[,q+27]
  #Y = data_M[,q+27]
  
  # delta
  X = data_F[,q+27] - data_F[,q+13]
  Y = data_M[,q+27] - data_M[,q+13]
  
  w = wilcox.test(x = X, y = Y, alternative = "two.sided")
  print(paste("Question ", q, sep=""))
  print(w$p.value)
  
}

```
*** 

# Figure S2: Net changes in self-efficacy obtained from summing changes of each student on all 14 of the self-efficacy items.

```{r}
# Calculate change in self-efficacy by subtracting pre-test results (as numbers, 1:5) from post-test results (as numbers, 1:5)
SE_pre = data[,14:27]
SE_post = data[,28:41]
SE_delta = SE_post - SE_pre # post - pre

# Add columns to delta- dataframe to identify each student (currently row names)
SE_delta$Student = row.names(SE_delta)

# Change question names
colnames(SE_delta) = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14", "Student")

# Melt data
mSE_delta = melt(SE_delta)
colnames(mSE_delta) <- c("Student", "Question", "Delta")

# Calcualte frequencies at which students improved are decreased in self-efficacy
delta_freq  = dcast(mSE_delta, Student~Delta)

# Calcualte net-change for each student, adding information about gender and years of expeirence working in a lab
delta_net = rowSums(cbind(delta_freq[,2]*-3, delta_freq[,3]*-2, delta_freq[,4]*-1, 0, delta_freq[,6], delta_freq[,7]*2, delta_freq[,8]*3))
delta_net = data.frame(dat = delta_net, gender = data$Sex, exp = data$LabExp, year = data$Year, stringsAsFactors = F)
dn_2018 = delta_net[(delta_net$year == "2018" & !is.na(delta_net$gender)),]
dn_2018$gender <- factor(dn_2018$gender, levels=c("Female", "Male"), ordered=TRUE)


# Calculate as %
percM = (hist(delta_net[delta_net$gender == "Male",'dat'], seq(-10, 35, 5), include.lowest = TRUE, plot = FALSE)$counts / nrow(delta_net[delta_net$gender == "Male",])) * 100
percF = (hist(delta_net[delta_net$gender == "Female",'dat'], seq(-10, 35, 5), include.lowest = TRUE, plot = FALSE)$counts / nrow(delta_net[delta_net$gender == "Female",])) * 100
df = data.frame(Sex = rep(c("Male", "Female"), each = 9), Freq = c(percM, percF), r = rep(seq(-10, 30, 5), 2), stringsAsFactors = FALSE)

# Create histogram
figS2A = ggplot(df, aes(x = r, y = Freq, fill = Sex)) + 
  geom_bar(position = position_dodge(), stat = "identity") + 
  scale_fill_manual(values = c("magenta4", "green4")) + 
#  scale_x_continuous(breaks=seq(-10, 20, 5)) + 
  theme_bw() + 
  xlab("Net change in self-efficacy") + ylab("Number of students") #+ 
#  theme(legend.position="none",
 #       panel.background=element_blank(),
  #      panel.grid.minor=element_blank(),
 #       plot.background=element_blank())

# Plot figure
plot(figS2A)

# Calculare medians
med_m = median(dn_2018[dn_2018$gender == "Male", 'dat'], na.rm = TRUE)
med_f = median(dn_2018[dn_2018$gender == "Female", 'dat'], na.rm = TRUE)

tmp <- ggplot(dn_2018[!is.na(dn_2018$gender),], aes(x = dat, fill = gender, color = gender)) + 
#  geom_histogram(binwidth = 4, aes(y = ..density..), position = position_dodge()) + 
  geom_rect(aes(xmin=-5, xmax=10, ymin=0, ymax=Inf), fill = "grey", linetype = "blank") + 
  geom_density(alpha = 0.5, adjust = 2) + 
  geom_vline(xintercept = med_m, color = "green4") + 
  geom_vline(xintercept = med_f, color = "magenta4") + 
  scale_fill_manual(values = c("magenta4", "green4")) + 
  scale_color_manual(values = c("magenta4", "green4")) + 
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

plot(tmp)
ggsave(tmp, file="Fig5A.svg", width = 4, height = 4)

```


Pie charts for top contributing factor
```{r}

dn_2018$topFactor = data_2018[,81]

a = data.frame(table(dn_2018[(dn_2018$dat < 10 & dn_2018$gender == "Female"), 'topFactor']))
b = data.frame(table(dn_2018[(dn_2018$dat < 10 & dn_2018$gender == "Male"), 'topFactor']))
c = data.frame(table(dn_2018[(dn_2018$dat > 10 & dn_2018$gender == "Female"), 'topFactor']))
d = data.frame(table(dn_2018[(dn_2018$dat > 10 & dn_2018$gender == "Male"), 'topFactor']))

sum(a$Freq)
sum(b$Freq)
sum(c$Freq)
sum(d$Freq)

pa <- ggplot(a, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_brewer(palette = "Spectral") + 
  theme_minimal() #+
 # theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

pb <- ggplot(b, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_brewer(palette = "Spectral") + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")


pc <- ggplot(c, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_brewer(palette = "Spectral") + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")


pd <- ggplot(d, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_brewer(palette = "Spectral") + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")


fig5b = grid.arrange(pc, pd, pa, pb, nrow = 2)
plot(fig5b)
ggsave(fig5b, file="Fig5b.svg", width = 4, height = 4)


```

***

# Figure S1: Students with the most learning potential learn the most in the first semester of graduate school.

Scatterplot comparint self-efficacy and net difference by question.
```{r}
# Calculate change in self-efficacy by subtracting pre-test results (as numbers, 1:5) from post-test results (as numbers, 1:5)
SE_pre = data[,14:27]
SE_post = data[,28:41]
SE_delta = SE_post - SE_pre # post - pre

# Add columns to pre- and delta- dataframes to identify each student (currently row names)
SE_pre$Student = row.names(SE_pre)
SE_delta$Student = row.names(SE_delta)

# Change question names
colnames(SE_pre) = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14", "Student")
colnames(SE_delta) = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14", "Student")

# Melt data
mSE_pre = melt(SE_pre)
mSE_delta = melt(SE_delta)

dat = cbind(mSE_pre, mSE_delta)[,c(1:3, 6)]
colnames(dat) <- c("Student", "Question", "Pre", "Delta")

# Create color scheme
dat$Color = "b" # If delta = 0
dat[dat$Delta > 0, "Color"] = "c" # if delta > 0
dat[dat$Delta < 0, "Color"] = "a" # if delta < 0

# Plot scatterplot
figS1a <- ggplot(dat, aes(Pre, Delta, color = Color)) + 
  geom_jitter(height = 0.25, width = 0.25, alpha = 0.4, size = 3, aes(shape = Question)) +
  scale_shape_manual(values=1:14) +
  scale_color_manual(values = c("#811617", "#F37627", "#FDCB41"), guide = FALSE) + 
  geom_abline(intercept = 0.5, slope = -1, linetype="dashed", color = "grey") +
  geom_abline(intercept = 5.5, slope = -1, linetype="dashed", color = "grey") + 
  scale_x_continuous(limits = c(0.7, 5.3), breaks = 1:5) + 
  scale_y_continuous(limits = c(-4.5, 3.5), breaks = -4:3) + 
  theme_bw() + 
  guides(shape=guide_legend(ncol=2)) +
  theme(panel.grid.minor = element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")

plot(figS1a)
ggsave(figS1a, file="~/Desktop/FigS1A.svg", width = 6, height = 4)
```

```{r}
# Construct a dataframe for a density plot of changes in student responses
SE_delta = SE_delta[,1:14]
SE_change = data.frame(red = rowSums(SE_delta < 0), purple = rowSums(SE_delta  == 0), blue = rowSums(SE_delta  > 0), stringsAsFactors = FALSE)

# Melt data frame for plotting
mSE_change = melt(SE_change)

figS1B <- ggplot(mSE_change, aes(x = value, fill = variable, color = variable)) + 
  geom_density(alpha = 0.7) +
  theme_bw() + 
  scale_fill_manual("", values = c("#811617", "#F37627", "#FDCB41"), labels = c("Decreased self-efficacy", "No change", "Increased self-efficacy")) + 
  scale_color_manual("", values = c("#811617", "#F37627", "#FDCB41"), labels = c("Decreased self-efficacy", "No change", "Increased self-efficacy")) + 
  scale_x_continuous(breaks=seq(0, 14, 2), labels=seq(0, 14, 2),limits=c(0,14)) + 
  scale_y_continuous(breaks=c(0, 0.1, 0.2), labels=c(0, 10, 20)) +
  theme(panel.grid.minor = element_blank(), panel.grid.major= element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="none")


plot(figS1B)
ggsave(figS1B, file="FigS1B.svg", width = 4, height = 4)
```

***

Figure S2: Clustering method
```{r}
library(ltm)
# Import data
data2017 = read.csv(file = "~/Desktop/BCMP\ 200\ Research/ExperimentalDesignResearchData.csv", header = TRUE, row.names = 1) # Import data
numStudents2017 = nrow(data2017) # Calculate number of students in cohort to be analyzed

data2018 = read.csv(file = "~/Desktop/BCMP\ 200\ Research/ExperimentalDesignResearchData2018.csv", header = TRUE, row.names = 1) # Import data
numStudents2018 = nrow(data2018) # Calculate number of students in cohort to be analyzed

# Calculate if self-efficacy distributions are same / different between years
Questions <- c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14")

pre_2017 = data2017[,1:14]
colnames(pre_2017) = Questions
post_2017 = data2017[,17:30]
colnames(post_2017) = Questions
delta_2017 = post_2017 - pre_2017
colnames(delta_2017) = Questions

gender_2017 = data2017$Gender

pre_2018 = data2018[,1:14]
colnames(pre_2018) = Questions
post_2018 = data2018[,41:54]
colnames(post_2018) = Questions
delta_2018 = post_2018 - pre_2018
colnames(delta_2018) = Questions

gender_2018 = data2018$Post_D10

# Combine data frames
mpre_2017 = melt(pre_2017)
mpre_2017$Test = "Pre"
mpre_2017$Year = "2017"
mpre_2017$Gender = rep(gender_2017, 14)

mpost_2017 = melt(post_2017)
mpost_2017$Test = "Post"
mpost_2017$Year = "2017"
mpost_2017$Gender = rep(gender_2017, 14)

mdelta_2017 = melt(delta_2017)
mdelta_2017$Test = "Delta"
mdelta_2017$Year = "2017"
mdelta_2017$Gender = rep(gender_2017, 14)

mpre_2018 = melt(pre_2018)
mpre_2018$Test = "Pre"
mpre_2018$Year = "2018"
mpre_2018$Gender = rep(gender_2018, 14)

mpost_2018 = melt(post_2018)
mpost_2018$Test = "Post"
mpost_2018$Year = "2018"
mpost_2018$Gender = rep(gender_2018, 14)

mdelta_2018 = melt(delta_2018)
mdelta_2018$Test = "Delta"
mdelta_2018$Year = "2018"
mdelta_2018$Gender = rep(gender_2018, 14)

total_pre = rbind(mpre_2017, mpre_2018)
total_post = rbind(mpost_2017, mpost_2018)
total_delta = rbind(mdelta_2017, mdelta_2018)
Questions = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14")
out = data.frame(matrix(0, nrow = length(Questions), ncol = length(Questions)), row.names = Questions, stringsAsFactors = FALSE)
colnames(out) = c("q1", "q2", "q3", "q4", "q5", "q6", "q7", "q8", "q9", "q10", "q11", "q12", "q13", "q14")

i = 1
for (Qi in Questions) {
  j = 1
  for (Qj in Questions) {
    #out[i, j] = round(cor(total_pre[total_pre$variable == Qi, "value"], total_pre[total_pre$variable == Qj, "value"], method = "spearman"), 2)
    #out[i, j] = round(cor(total_post[total_post$variable == Qi, "value"], total_post[total_post$variable == Qj, "value"], method = "spearman"), 2)
    out[i, j] = round(cor(total_delta[total_delta$variable == Qi, "value"], total_delta[total_delta$variable == Qj, "value"], method = "spearman"), 2)
    #out[i, j] = round(cronbach.alpha(cbind(total_pre[total_pre$variable == Qi, "value"], total_pre[total_pre$variable == Qj, "value"]))$alpha, 2)
    #out[i, j] = round(cronbach.alpha(cbind(total_post[total_post$variable == Qi, "value"], total_post[total_post$variable == Qj, "value"]))$alpha, 2)
    #out[i, j] = round(cronbach.alpha(cbind(total_delta[total_delta$variable == Qi, "value"], total_delta[total_delta$variable == Qj, "value"]))$alpha, 2)
    
    
    j = j + 1
    
  }
  i = i + 1
}

library(ggdendro)
library(plotly)


# Cluster
row.order <- hclust(dist(out, method = "euclidean"), method="ward.D")$order
col.order <- hclust(dist(t(out), method = "euclidean"), method="ward.D")$order
out_new <- out[row.order, col.order]
m_out <- melt(as.matrix(out_new))
names(m_out)[c(1:2)] <- c("QUESTIONS", "questions")

# Dendrograms
dd.col <- as.dendrogram(hclust(dist(out, method = "euclidean"), method="ward.D"))
dd.row <- as.dendrogram(hclust(dist(t(out), method = "euclidean"), method="ward.D"))

dx <- dendro_data(dd.row)
dy <- dendro_data(dd.col)

# helper function for creating dendograms
ggdend <- function(df) {
  ggplot() +
    geom_segment(data = df, aes(x=x, y=y, xend=xend, yend=yend)) +
    theme_bw() + 
    labs(x = "", y = "") + theme_minimal() +
    theme(axis.text = element_blank(), axis.ticks = element_blank(),
          panel.grid = element_blank())
}

# x/y dendograms
px <- ggdend(dx$segments)
py <- ggdend(dy$segments) + coord_flip()

# Plot
q1 = ggplot(data = m_out, aes(x = QUESTIONS, y = questions, fill = 1 - value)) + 
  geom_raster() +
  theme_bw() + 
  scale_fill_distiller(palette = "Greys",) + # pre = blues, post = oranges, delta = greys
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.ticks.x=element_blank(), axis.ticks.y=element_blank()) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  theme(legend.position = "none") 


plot(q1)
ggsave(q1, file="delta.svg", width = 4, height = 4)
plot(px)
ggsave(px, file="deltaD.svg", width = 4, height = 4)
plot(py)

```


***

# Figure S3

```{r}
# Split data by responses to self-efficacy questionaire before and after the first semester of graduate school
SE_pre = data_2018[,c(2,14:27)] # Change 2017 / 2018

# Split by gender
femaleSE_pre = SE_pre[SE_pre$Sex == "Female",]
maleSE_pre = SE_pre[SE_pre$Sex == "Male",]

# Count number of students
numFemaleStudents = nrow(femaleSE_pre)
numMaleStudents = nrow(maleSE_pre)

# Melt responses
m_femaleSE_pre = melt(femaleSE_pre)
m_maleSE_pre = melt(maleSE_pre)

# Add question number label to each array
m_femaleSE_pre$variable = rep(c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), each = numFemaleStudents)
m_maleSE_pre$variable = rep(c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), each = numMaleStudents)

# Change labels to strings for categorical plotting
m_femaleSE_pre[m_femaleSE_pre$value==1,"value"] = "a1" # Not at all, female
m_femaleSE_pre[m_femaleSE_pre$value==2,"value"] = "b1" # A little, female
m_femaleSE_pre[m_femaleSE_pre$value==3,"value"] = "c1" # A moderate amount, female
m_femaleSE_pre[m_femaleSE_pre$value==4,"value"] = "d1" # A lot, female
m_femaleSE_pre[m_femaleSE_pre$value==5,"value"] = "e1" # A great deal, female

m_maleSE_pre[m_maleSE_pre$value==1,"value"] = "a2" # Not at all, male
m_maleSE_pre[m_maleSE_pre$value==2,"value"] = "b2" # A little, male
m_maleSE_pre[m_maleSE_pre$value==3,"value"] = "c2" # A moderate amount, male
m_maleSE_pre[m_maleSE_pre$value==4,"value"] = "d2" # A lot, male
m_maleSE_pre[m_maleSE_pre$value==5,"value"] = "e2" # A great deal, male

# Combine gender dataframes for plotting
m_gSE_pre <- rbind(m_femaleSE_pre, m_maleSE_pre)

# Order variables for plotting
m_gSE_pre$variable <- factor(m_gSE_pre$variable, levels = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), ordered = TRUE)
m_gSE_pre$Sex <- factor(m_gSE_pre$Sex , levels = c("Female", "Male"), ordered = TRUE)

# Create stacked bar chart for each question, for male and female students
figS6A <- ggplot(m_gSE_pre, aes(Sex)) + 
  geom_bar(aes(fill=value), position = "fill") + facet_grid(~ variable) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("a1" = "#D5ACD9", "b1" = "#BE7DC4", "c1" = "#9A33A2", "d1" = "#67006F", "e1" = "#420047", "a2" = "#ACD9AC", "b2" = "#7DC47D", "c2" = "#33A233", "d2" = "#006F00", "e2" = "#004700")) + 
#  scale_fill_manual("legend", values = c("a1" = "#fdeef0", "b1" = "#f9d2da", "c1" = "#f19eb1", "d1" = "#e96088", "e1" = "#e30066", "a2" = "#d0dfff", "b2" = "#c1d4fb", "c2" = "#a8c2fb", "d2" = "#86abf9", "e2" = "#6893ee")) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        legend.position="none",
        strip.background = element_blank(), 
        strip.text = element_blank())

# Plot figure
plot(figS6A)


# POST
# Split data by responses to self-efficacy questionaire before and after the first semester of graduate school
SE_pre = data_2018[,c(2,28:41)]

# Split by gender
femaleSE_pre = SE_pre[SE_pre$Sex == "Female",]
maleSE_pre = SE_pre[SE_pre$Sex == "Male",]

# Count number of students
numFemaleStudents = nrow(femaleSE_pre)
numMaleStudents = nrow(maleSE_pre)

# Melt responses
m_femaleSE_pre = melt(femaleSE_pre)
m_maleSE_pre = melt(maleSE_pre)

# Add question number label to each array
m_femaleSE_pre$variable = rep(c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), each = numFemaleStudents)
m_maleSE_pre$variable = rep(c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), each = numMaleStudents)

# Change labels to strings for categorical plotting
m_femaleSE_pre[m_femaleSE_pre$value==1,"value"] = "a1" # Not at all, female
m_femaleSE_pre[m_femaleSE_pre$value==2,"value"] = "b1" # A little, female
m_femaleSE_pre[m_femaleSE_pre$value==3,"value"] = "c1" # A moderate amount, female
m_femaleSE_pre[m_femaleSE_pre$value==4,"value"] = "d1" # A lot, female
m_femaleSE_pre[m_femaleSE_pre$value==5,"value"] = "e1" # A great deal, female

m_maleSE_pre[m_maleSE_pre$value==1,"value"] = "a2" # Not at all, male
m_maleSE_pre[m_maleSE_pre$value==2,"value"] = "b2" # A little, male
m_maleSE_pre[m_maleSE_pre$value==3,"value"] = "c2" # A moderate amount, male
m_maleSE_pre[m_maleSE_pre$value==4,"value"] = "d2" # A lot, male
m_maleSE_pre[m_maleSE_pre$value==5,"value"] = "e2" # A great deal, male

# Combine gender dataframes for plotting
m_gSE_pre <- rbind(m_femaleSE_pre, m_maleSE_pre)

# Order variables for plotting
m_gSE_pre$variable <- factor(m_gSE_pre$variable, levels = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14"), ordered = TRUE)
m_gSE_pre$Sex <- factor(m_gSE_pre$Sex , levels = c("Female", "Male"), ordered = TRUE)

# Create stacked bar chart for each question, for male and female students
figS6B <- ggplot(m_gSE_pre, aes(Sex)) + 
  geom_bar(aes(fill=value), position = "fill") + facet_grid(~ variable) + 
  theme_bw() + 
  scale_fill_manual("legend", values = c("a1" = "#D5ACD9", "b1" = "#BE7DC4", "c1" = "#9A33A2", "d1" = "#67006F", "e1" = "#420047", "a2" = "#ACD9AC", "b2" = "#7DC47D", "c2" = "#33A233", "d2" = "#006F00", "e2" = "#004700")) + 
#  scale_fill_manual("legend", values = c("a1" = "#fdeef0", "b1" = "#f9d2da", "c1" = "#f19eb1", "d1" = "#e96088", "e1" = "#e30066", "a2" = "#d0dfff", "b2" = "#c1d4fb", "c2" = "#a8c2fb", "d2" = "#86abf9", "e2" = "#6893ee")) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank(),
        legend.position="none",
        strip.background = element_blank(), 
        strip.text = element_blank())

# Plot figure
plot(figS6B)

fig = grid.arrange(figS6A, figS6B, nrow = 1)
plot(fig)
ggsave(fig, file="FigS3_18.svg", width = 8, height = 4)


```

```{r}
# Calculate change in self-efficacy by subtracting pre-test results (as numbers, 1:5) from post-test results (as numbers, 1:5)
SE_pre = data[,14:27]
SE_post = data[,28:41]
SE_delta = SE_post - SE_pre # post - pre

# Add columns to delta- dataframe to identify each student (currently row names)
SE_delta$Student = row.names(SE_delta)

# Change question names
colnames(SE_delta) = c("Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10", "Q11", "Q12", "Q13", "Q14", "Student")

# Melt data
mSE_delta = melt(SE_delta)
colnames(mSE_delta) <- c("Student", "Question", "Delta")

# Calcualte frequencies at which students improved are decreased in self-efficacy
delta_freq  = dcast(mSE_delta, Student~Delta)

# Calcualte net-change for each student, adding information about gender and years of expeirence working in a lab
delta_net = rowSums(cbind(delta_freq[,2]*-4, delta_freq[,3]*-3, delta_freq[,4]*-2, delta_freq[,5]*-1, 0, delta_freq[,7], delta_freq[,8]*2, delta_freq[,9]*3))
delta_net = data.frame(dat = delta_net, gender = data$Sex, exp = data$LabExp, stringsAsFactors = F)

# Add color labels
delta_net$col = "p"
delta_net[delta_net$dat < 0, 'col'] ="r"
delta_net[delta_net$dat > 0, 'col'] = "b"

# Create histogram
figS2A = ggplot(delta_net, aes(x = dat, fill = col)) + 
  geom_histogram(binwidth = 0.5) + 
  scale_fill_manual(values = c("#FDCB41", "#F37627", "#811617")) + 
  scale_x_continuous(breaks=seq(-20, 20, 5)) + 
  scale_y_continuous(breaks=seq(0, 10, 2)) + 
  theme_bw() + 
  xlab("Net change in self-efficacy") + ylab("Number of students") + 
  theme(legend.position="none",
        panel.background=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank()) + 
    theme(legend.position="none",
        panel.background=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank())


# Plot figure
plot(figS2A)
ggsave(figS2A, file="FigSupp_1.svg", width = 8, height = 4)


a = data.frame(Var1 = c("Female", "Male"), Freq = c(nrow(delta_net[delta_net$dat < 0 & delta_net$gender == "Female",]), nrow(delta_net[delta_net$dat < 0 & delta_net$gender == "Male",])), stringsAsFactors = FALSE)
pa <- ggplot(a, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values = c("magenta4", "green4")) + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

b = data.frame(Var1 = as.character(1:7), Freq = c(nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 1,]), nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 2,]), nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 3,]), nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 4,]), nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 5,]), nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 6,]), nrow(delta_net[delta_net$dat < 0 & delta_net$exp == 7,])), stringsAsFactors = FALSE)
b$Var1 <- factor(b$Var1, levels = c("7", "6", "5", "4", "3", "2", "1"))
pb <- ggplot(b, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values=c("#333333", "#4C4C4C", "#666666", "#808080", "#999999", "#B2B2B2", "#CCCCCC")) + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

figA = grid.arrange(pa, pb, nrow = 1)
plot(figA)
ggsave(figA, file="FigSupp_2.svg", width = 4, height = 2)
```


```{r}
# Calculate total change in BEDCI score (post - pre)
CI_delta = data.frame(Score = (data_2017$Post_CITotal - data_2017$Pre_CITotal), Gender = data_2017$Sex, Exp = data_2017$LabExp, stringsAsFactors = FALSE)

# Add color labels
CI_delta$Col = "p"
CI_delta[CI_delta$Score < 0, 'Col'] ="r"
CI_delta[CI_delta$Score > 0, 'Col'] = "b"

# Create histogram
figS3A = ggplot(CI_delta, aes(x = Score, fill = Col)) + 
  geom_histogram(binwidth = 0.5) + 
  scale_fill_manual(values = c("#FDCB41", "#F37627", "#811617")) + 
  scale_x_continuous(breaks=seq(-4, 4, 1)) + 
  theme_bw() + 
  xlab("Change in BEDCI score") + ylab("Number of students") + 
  theme(legend.position="none",
        panel.background=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank()) + 
    theme(legend.position="none",
        panel.background=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank())


# Plot figure
plot(figS3A)
ggsave(figS3A, file="FigSupp_3.svg", width = 4, height = 2)


a = data.frame(Var1 = c("Female", "Male"), Freq = c(nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Gender == "Female",]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Gender == "Male",])), stringsAsFactors = FALSE)
pa <- ggplot(a, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values = c("magenta4", "green4")) + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

b = data.frame(Var1 = as.character(1:7), Freq = c(nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 1,]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 2,]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 3,]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 4,]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 5,]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 6,]), nrow(CI_delta[CI_delta$Score < 0 & CI_delta$Exp == 7,])), stringsAsFactors = FALSE)
b$Var1 <- factor(b$Var1, levels = c("7", "6", "5", "4", "3", "2", "1"))
pb <- ggplot(b, aes(x="", y=Freq, fill = Var1))+
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values=c("#333333", "#4C4C4C", "#666666", "#808080", "#999999", "#B2B2B2", "#CCCCCC")) + 
  theme_minimal() #+
#  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), panel.border = element_blank(), panel.grid=element_blank(), axis.ticks = element_blank(), axis.text.x=element_blank(), legend.position= "none")

figA = grid.arrange(pa, pb, nrow = 1)
plot(figA)
ggsave(figA, file="FigSupp_4.svg", width = 4, height = 2)

```